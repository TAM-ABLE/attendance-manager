# Slack連携セットアップガイド（管理者向け）

勤怠管理システムとSlackを連携するための設定手順です。
Slackワークスペースの管理者の方が対応してください。

---

## 目次

1. [連携でできること](#1-連携でできること)
2. [Slackアプリの作成](#2-slackアプリの作成)
3. [Bot Token Scopesの設定](#3-bot-token-scopesの設定)
4. [アプリのインストール](#4-アプリのインストール)
5. [チャンネルの準備](#5-チャンネルの準備)
6. [開発者に共有する情報](#6-開発者に共有する情報)

---

## 1. 連携でできること

| 機能 | 説明 | 投稿先チャンネル |
|------|------|-----------------|
| 出勤通知 | 出勤時にユーザー名・本日の予定タスクをSlackに投稿 | 勤怠通知チャンネル |
| 退勤通知 | 退勤時に業務内容・まとめ・困りごと等をスレッドで投稿 | 勤怠通知チャンネル |
| 月次勤怠CSV送信 | 月次締め時に勤怠CSVファイルをSlackにアップロード | CSV送信チャンネル |

---

## 2. Slackアプリの作成

1. [Slack API: Your Apps](https://api.slack.com/apps) にアクセス
2. **「Create New App」** をクリック
3. **「From scratch」** を選択
4. 以下を入力：
   - **App Name**: `勤怠管理Bot`（任意の名前）
   - **Pick a workspace**: 連携対象のワークスペースを選択
5. **「Create App」** をクリック

---

## 3. Bot Token Scopesの設定

左メニューから **「OAuth & Permissions」** を開き、**「Scopes」** セクションの **「Bot Token Scopes」** に以下を追加してください。

| Scope | 用途 |
|-------|------|
| `chat:write` | メッセージの送信（出勤・退勤通知） |
| `chat:write.customize` | カスタムユーザー名でのメッセージ送信 |
| `files:write` | ファイルのアップロード（月次勤怠CSV送信） |

### 追加手順

1. **「Bot Token Scopes」** の **「Add an OAuth Scope」** をクリック
2. 上記3つのScopeを1つずつ検索して追加

---

## 4. アプリのインストール

Scopeの設定後、アプリをワークスペースにインストールします。

1. 左メニューから **「OAuth & Permissions」** を開く
2. ページ上部の **「Install to Workspace」**（または **「Reinstall to Workspace」**）をクリック
3. 権限を確認して **「許可する」** をクリック
4. **「Bot User OAuth Token」**（`xoxb-` で始まる文字列）が表示されるので、コピーして控えてください

> **注意**: Scopeを追加・変更した場合は、再度 **「Reinstall to Workspace」** が必要です。

---

## 5. チャンネルの準備

2つのチャンネルが必要です（1つにまとめることも可能です）。

### 5-1. 勤怠通知チャンネル（出勤・退勤通知用）

出勤・退勤の通知メッセージが投稿されます。

1. Slackでチャンネルを作成（例: `#勤怠通知`、`#attendance`）
2. 作成したチャンネルに **Botを追加**：
   - チャンネルを開く → 上部のチャンネル名をクリック → **「インテグレーション」** タブ → **「アプリを追加する」** → 作成したアプリを選択

### 5-2. CSV送信チャンネル（月次勤怠CSV用）

月次勤怠締め時にCSVファイルがアップロードされます。

1. Slackでチャンネルを作成（例: `#勤怠csv`、`#attendance-csv`）
2. 同様にBotを追加

> **Botをチャンネルに追加しないと、メッセージ送信・ファイルアップロードが失敗します。** 必ず追加してください。

### チャンネルIDの確認方法

各チャンネルのIDを以下の方法で確認してください。

1. Slackでチャンネルを開く
2. 上部の **チャンネル名をクリック**
3. ポップアップの最下部に表示される **チャンネルID**（`C` で始まる英数字）をコピー

または、チャンネルを右クリック → **「リンクをコピー」** でURLを取得し、末尾の文字列がチャンネルIDです。
例: `https://your-workspace.slack.com/archives/C01ABCDEFGH` → `C01ABCDEFGH`

---

## 6. 開発者に共有する情報

以下の3つの値を開発者に共有してください。

| 項目 | 値の形式 | 例 |
|------|----------|-----|
| **Bot User OAuth Token** | `xoxb-` で始まる文字列 | `xoxb-xxxx...xxxx`（実際は長い英数字の文字列） |
| **勤怠通知チャンネルID** | `C` で始まる英数字 | `C01ABCDEFGH` |
| **CSV送信チャンネルID** | `C` で始まる英数字 | `C02XYZABCDE` |

---

## 参考: 開発者が設定する環境変数

共有された情報は、以下の環境変数として設定されます（参考情報）。

```
SLACK_BOT_TOKEN=xoxb-...           # Bot User OAuth Token
SLACK_CHANNEL_ID=C01ABCDEFGH       # 勤怠通知チャンネルID
SLACK_CSV_CHANNEL_ID=C02XYZABCDE   # CSV送信チャンネルID
```
